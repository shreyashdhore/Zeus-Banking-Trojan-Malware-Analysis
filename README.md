# Zeus Banking Trojan

## Lab setup

1. **Download Virtualbox:** 

[Downloads     – Oracle VM VirtualBox](https://www.virtualbox.org/wiki/Downloads)

1. **Download Windows 10 Enterprise**

[Microsoft](https://info.microsoft.com/ww-landing-windows-10-enterprise.html)

1. **Download Remnux**

[Get the Virtual Appliance](https://docs.remnux.org/install-distro/get-virtual-appliance)

Step 1: Setup Virtual machine for the FlareVM using the Windows ISO file

Step 2: After installation disable some windows settings

1. Change proxy settings: Turn automatically detect settings off
2. Disable windows defender from settings
3. Setup group settings:
    1. Go to edit group policy from windows search
    2. Go to Administrative Templates
        1. Click on windows components
            1. Click on Micro Defender AV
            2. Click on “TURN OFF MICRO DEFENDER AV”
            3. Enable it
        
    
        2.   Click on Network connections
    
    
              1. Click on windows defender firewall ——> Domain Profile ——> Protect all         networks connections ——> Click Disable
        
        
        Now click on Standard Profile ——> Protect all network connections ——> Disable
        
    

Step 3: Create a first Snapshot of the FlareVM (rename to WIN10 BASE)

Step 4: Open Powershell as admin

1. Change directory to desktop
2. Paste this script in the shell : (New-Object net.webclient).DownloadFile('[https://raw.githubusercontent.com/man...]
,"$([Environment]::GetFolderPath("Desktop"))\\install.ps1")
3. Now write this “Unblock-File .\\install.ps1”
4. Next write this “Set-ExecutionPolicy Unrestricted”
5. Final step  “.\install.ps1”
6. After step 5 it will give a box as below, click OK

It will download all the necessary packages 

Step 6: Import REMnux to VM 

Step 7: Now create a network in VM

1. Click tools ——> Create
2. Edit IP address to 10.0.0.1 and apply the settings
3. Edit DHCP server address to 10.0.0.2
4. Lower Address bound: 10.0.0.3
5. Upper Address bound: 10.0.0.254

<aside>
💡 VirtualBox Host-only Ethernet Adaptor establish connection b/w REMnux and FlareVM for communication

</aside>

Step 8: Configuration in REMnux

1. Navigate to cd /etc/inetsim
2. sudo nano inetsim.conf
3. Uncomment the “start_service dns”
4. Change the service_bind_address from 10.10.10.1 to 0.0.0.0 
5. Change the dns_default_ip from 10.10.10.1 to 10.0.04
6. Save changes and exit

Step 9: Open the failed_packages.txt from the desktop in the Flare VM after all the packages has been downloaded

Step 10: Download Sysinternals from microsoft and extract it into this path
”THIS PC ——> Local Disk C ——> ProgramData ——> Microsoft ——> Windows ——> Start Menu ——> Programs ——> Tools 

Step 11: Change network settings of VM to establish connection between the RUMnux box and Flare VM box

1. Change the network to “Host only Adaptor” of both the VMs

Step 12: Change the Ethernet settings of Flare VM by editing the DNS server to 10.0.0.4

Step 13: Now check connection by doing the ping in both Vms opposite Ip address

## Now the Self hosted Lab is setup.

## 1. Overview of the Project Analysis

- Overview of Analysis tools
- Provision Lab
- Conduct Analysis
    
    Download Zeus Banking Trojan
    
    Label Malware(hashes) & VirusTotal
    
    Basic Static Analysis
    
    Basic Dynamic Analysis
    
    Report & IOCs
    

1. Pre-requisites
- Malware Analysis Lab Built
- Snapshot of Base image
- Established Internet Connection
    
    Zeus Banking Trojan Virus link (https://github.com/ytisf/theZoo/tree/master/malware/Binaries/ZeusBankingVersion_26Nov2013)
    

1. VirusTotal: 
    
    Analysis tool used to assess malicious files, domains, IP addresses, and URLs to detect malware.
    
    Used to fingerprint a malicious sample and measure its functionality against established security
    engines
    
2. PeStudio
    
    Program used to statically analyze malware and identify artifacts of interest
    
    - Collects static information:
    • Hashes
    • File Header
    • File Properties
    • Strings
    • Libraries Used
    • Imports

1. Floss
    
    Extracts strings from executables.
    Uses advanced static analysis technique to automatically deobfuscate strings from malware
    binaries
    
    Usage : floss malicious.exe
    
2. Capa
    - Automatically detects capabilities of program and outputs what it thinks it can the program can do
    Behavior is mapped to the MITRE ATT&CK framework

1. Cutter
    
      Reverse-engineering platform.
    • Used to view assembly-level instructions of programs.
    • View decompiled code.
    
2. INetSim
    
     Software suite used for simulating common internet services.
     Can be used to analyze the network behavior for malware samples.
    
3. Wireshark
    
    Network packet sniffer and analyzer. Used for network troubleshooting and packet analysis.
    
4. Process Monitor (Procmon)
    
    Apart of the Sysinternals Suite
    
    Monitors and displays real-time information on the Windows filesystem.
    • Captures events from five different classes:
    • Registry
    • Filesystem
    • Network
    • Processes
    • Profiling Events
    
5. YARA
    
    Used to classify and identify malware samples by creating “rules” of malware families based on
    textual or binary patterns.
    • YARA rules are written by defining variables with interesting strings and byte sequences. Variables are evaluated by the condition block, which implements the logic of where, how, or when strings or byte sequences occur.
    
    Ex:
    
    rule Zeus_IOC {
    strings:
    $file_name="invoice_2318362983713_823931342io.pdf.exe" ascii
    $PE_magic_byte="MZ“
    condition:
    $PE_magic_byte at 0 and $filename
    }
    

# Lab

Malware Composition
Filename: invoice_2318362983713_823931342io.pdf.exe
Hashes:
             md5: EA039A854D20D7734C5ADD48F1A51C34
             sha1: 9615DCA4C0E46B8A39DE5428AF7DB060399230B2
             sha256: 69E966E730557FDE8FD84317CDEF1ECE00A8BB3470C0B58F3231E170168AF169

## Basic Static Analysis
Virus Total

Strings
Tools Used: PeStudio, Floss.exe, & Capa

Interesting API Calls

AllowSetForegroundWindow: Allows a specified process to set the foreground window even if the
process does not currently own the foreground windows focus.
GetCapture
GetWindowTextLength
GetEnvironmentVariable
GetEnvironmentVariable
VkKeyScan: Translates a character to the corresponding virtual-key code.
GetAsyncKeyState: Allows you to determine whether a particular key is currently pressed or
released.
PathRenameExtension
WriteFile

Virtual Size vs Raw Data

Libraries
KERNEL32.dll
SHLWAPl.dll
USER32.dll

File Header


Basic Capa Output

Appears this Zeus variant uses VM / Sandbox Evasion techniques to avoid inspection.

String Address Location
Looking into a set of extracted strings (random gibberish followed by a DLL function):


## Basic Dynamic Analysis

Host-based Indicators
Tools Used: Procmon, INetSim, & Wireshark


Under invoice parent process has two child processes, including a suspended cmd.exe with a child
conhost.exe 

Under wininit.exe -> svchost.exe -> GoogleUpdate.exe is dropped

## Network-based Indicators

Start inetsim to simulate DNS server and Wireshark for packet capture.

Captured a suspicious HTTP request out to [fpdownload.macromedia.com](http://fpdownload.macromedia.com/) .

## Detection Rules (YARA)

YARA rule used to detect the Zeus Banking Trojan Version 26-Nov-2013.
// import pe
rule Zeus {
meta:
author="Grant C."
description="A detection rule against ZuesBankingVersion_26Nov2013"
strings:
$file_name="invoice_2318362983713_823931342io.pdf.exe" ascii
// Suspected name of functions and DLL functionalities.

$function_name_KERNEL32="AsksmaceaglyBubuPulsKaifTeasMistPeelGhisPrimChaoLyr
eroeno" ascii
$function_name_KERNERL32_CreateFileA="CellrotoCrudUntohighCols"
ascii
$function_name_KERNEL32_FINDFIRSTFILEA="GeneAilshe" ascii
// PE Magic Byte.
$PE_magic_byte="MZ"
// Hex String Function Name + DLL.
$hex_string_SHLWAPI_PATHREMOVEFILESPECA= {44 65 6E 79 4C 75 62 65 44
75 6E 73 73 61 77 73 4F 72 65 73 76 61 72 75 74 00 53 48 4C 57 41 50 49}
condition:
// Use the pe library to create fine-grained rules for PE files.
// pe.ispie
$PE_magic_byte at 0 and $filename
and $function_name_KERNEL32
or $function_name_KERNERL32_CreateFileA
or $function_name_KERNEL32_FINDFIRSTFILEA
and $hex_string_SHLWAPI_PATHREMOVEFILESPECA


Run the yara64 zeus_rule.yara invoice_2318362983713_823931342io.pdf.exe -s -w -p 32
to detect this malware variant based on unique strings.
-s : Print matched strings to stdout.
-w : Ignore warnings.
p 32 : Allocate 32 threads
